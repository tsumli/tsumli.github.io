<!doctype html><html lang=ja><head><title>DockerでSingularityのImageをbuildする | tsumli-pages</title><meta charset=utf-8><meta name=language content="en"><meta name=description content><meta name=keywords content="singularity ,abci ,docker"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><link rel="shortcut icon" type=image/png href=https://tsumli.github.io/favicon.ico><link type=text/css rel=stylesheet href=https://tsumli.github.io/css/post.min.b60e0932fe1c50c3d7c5b4f83ee9e4592363654d0f2abf05bbd0678d5b8a214c.css integrity="sha256-tg4JMv4cUMPXxbT4PunkWSNjZU0PKr8Fu9BnjVuKIUw="><link type=text/css rel=stylesheet href=https://tsumli.github.io/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tsumli.github.io\/"},"articleSection":"blog","name":"DockerでSingularityのImageをbuildする","headline":"DockerでSingularityのImageをbuildする","description":"","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2021","datePublished":"2021-04-16 18:01:52 \u002b0000 UTC","dateModified":"2021-04-16 18:01:52 \u002b0000 UTC","url":"https:\/\/tsumli.github.io\/blog\/abci\/docker-build-singularity\/","wordCount":"888","keywords":["singularity","abci","docker","Blog"]}</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-188554402-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=https://tsumli.github.io/>about</a></li><li><a class=active href=https://tsumli.github.io/blog>blog</a></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>DockerでSingularityのImageをbuildする</h1><time datetime="2021-04-16 18:01:52 +0000 UTC" class=post__date>Apr 16 2021</time>
<link rel=stylesheet href=https://tsumli.github.io//css/lightbox.min.css><script type=text/javascript>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,tags:"ams",autoload:{color:[],colorV2:['color']},packages:{'[+]':['noerrors']}},chtml:{matchFontHeight:false,displayAlign:"left",displayIndent:"2em"},options:{skipHtmlTags:['script','noscript','style','textarea','pre'],renderActions:{find_script_mathtex:[10,function(doc){for(const node of document.querySelectorAll('script[type^="math/tex"]')){const display=!!node.type.match(/; *mode=display/);const math=new doc.options.MathItem(node.textContent,doc.inputJax[0],display);const text=document.createTextNode('');node.parentNode.replaceChild(text,node);math.start={node:text,delim:'',n:0};math.end={node:text,delim:'',n:0};doc.math.push(math);}},'']}},loader:{load:['[tex]/noerrors']}};</script><script type=text/javascript async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js id=MathJax-script></script><link rel=stylesheet type=text/css href=https://tsumli.github.io/css/mathjax-style.css></header><article class=post__content><p>dockerでsingularityのimage file (.sif) を作成したときのメモ書きです．</p><h2 id=motivation>Motivation<a class=anchor href=#motivation>#</a></h2><p>ローカルPCでsingularity buildしたい (docker image to singularity image) けど，ローカルPCの環境を汚したくない，という状況です．</p><h2 id=method>Method<a class=anchor href=#method>#</a></h2><p>まず，もととなるdocker imageを用意します．例えばこれをfoo:latestとします．
一般的な方法 (コンテナ内でsingularityをインストールし，そこからfoo:latestを変換する) でbuildしようとしても，
コンテナ内からdocker imageを見ることができないため不可能です．</p><p>そこで，Docker out of Docker (DooD) という方法でbuildしていきます
(実際にはコンテナからコンテナを操作しているわけではないので，この用語は適切でないかもしれません)．
やり方としては簡単で，ホストのdocker.sockをマウントして実行することで，ホストのdocker imageをコンテナに共有することができます．
以下のようなshellscriptを作成し，保存します．
今回はquay.ioからimageを持ってきました．<a href="https://quay.io/repository/singularity/singularity?tab=tags" target=_blank rel="noreferrer noopener">Tags</a>
を見ることで，
他のsingularityのバージョンなどに適宜変更できます．</p><pre><code class=language-shell># build_singularity.sh
docker run --rm -v &quot;$PWD&quot;:/src/ -w=&quot;/src/&quot; -v /var/run/docker.sock:/var/run/docker.sock quay.io/singularity/singularity:v3.7.2 build /src/${NAME}.sif docker-daemon://${IMAGE}
</code></pre><p>このshellscriptを次のように実行します．</p><pre><code class=language-shell>IMAGE=foo:latest NAME=foo sh build_singularity.sh 
</code></pre><p>結果として，カレントディレクトリに${NAME}.sifが生成されます．
あとはGPUサーバに上げるなりして使うことができます．</p><hr><p>感想として，.sifファイルは.defファイルから作成するよりもdocker imageから作成する方が簡単でした (単に慣れの問題かもしれません).
セキュリティの問題でremoteサーバでdockerが使えず，singularityが推奨されることが多いので，
このように簡単にimageファイルが作成できるのはうれしいです．</p><h2 id=追記20210728>追記（2021/07/28）<a class=anchor href=#追記20210728>#</a></h2><p>公式のgithubレポジトリに同様のものを発見しました （https://github.com/singularityhub/docker2singularity）
こっちのほうが使うときに楽でいいかもしれません</p><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://tsumli.github.io/tags/singularity/>singularity</a></li><li class=tag__item><a class=tag__link href=https://tsumli.github.io/tags/abci/>abci</a></li><li class=tag__item><a class=tag__link href=https://tsumli.github.io/tags/docker/>docker</a></li></ul><div class=pagination><a class=pagination__item href=https://tsumli.github.io/blog/optimal-transport/03-unbalanced/><span class=pagination__label>Previous Post</span>
<span class=pagination__title>Optimal Transport 03. Unbalanced Optimal Transport</span></a>
<a class=pagination__item href=https://tsumli.github.io/blog/paper/StarGANv2/><span class=pagination__label>Next Post</span>
<span class=pagination__title>StarGAN v2 を読む</span></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link rel=me title=GitHub href=https://github.com/tsumli target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://tsumli.github.io/svg/github.svg)></div></a><a class=social-icons__link rel=me title=Medium href=https://medium.com/@tsumli target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://tsumli.github.io/svg/medium.svg)></div></a></div><p>© 2022</p><script src=https://code.jquery.com/jquery-3.4.1.min.js integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin=anonymous></script><link rel=stylesheet href=https://tsumli.github.io//css/lightbox.min.css><script src=https://tsumli.github.io//js/lightbox.min.js></script></footer></div></div><div class=toc-container><div class=toc-post-title>DockerでSingularityのImageをbuildする</div><nav id=TableOfContents><ul><li><a href=#motivation>Motivation</a></li><li><a href=#method>Method</a></li><li><a href=#追記20210728>追記（2021/07/28）</a></li></ul></nav></div></div></main><script src=https://tsumli.github.io/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr+kQ=" crossorigin=anonymous></script><script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script><script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script><script src=https://tsumli.github.io/js/table-of-contents.js></script></body></html>