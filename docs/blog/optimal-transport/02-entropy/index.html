<!doctype html><html lang=ja><head><title>Optimal Transport 02. エントロピー正則化 | tsumli-pages</title><meta charset=utf-8><meta name=language content="en"><meta name=description content><meta name=keywords content="optimal-transport ,最適輸送理論 ,最適輸送問題"><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><link rel="shortcut icon" type=image/png href=https://tsumli.github.io/favicon.ico><link type=text/css rel=stylesheet href=https://tsumli.github.io/css/post.min.b60e0932fe1c50c3d7c5b4f83ee9e4592363654d0f2abf05bbd0678d5b8a214c.css integrity="sha256-tg4JMv4cUMPXxbT4PunkWSNjZU0PKr8Fu9BnjVuKIUw="><link type=text/css rel=stylesheet href=https://tsumli.github.io/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU="><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/tsumli.github.io\/"},"articleSection":"blog","name":"Optimal Transport 02. エントロピー正則化","headline":"Optimal Transport 02. エントロピー正則化","description":"","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2021","datePublished":"2021-02-13 13:55:54 \u002b0000 UTC","dateModified":"2021-02-13 13:55:54 \u002b0000 UTC","url":"https:\/\/tsumli.github.io\/blog\/optimal-transport\/02-entropy\/","wordCount":"1152","keywords":["optimal-transport","最適輸送理論","最適輸送問題","Blog"]}</script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-188554402-1','auto');ga('send','pageview');}</script><script async src=https://www.google-analytics.com/analytics.js></script></head><body><div class=burger__container><div class=burger aria-controls=navigation aria-label=Menu><div class="burger__meat burger__meat--1"></div><div class="burger__meat burger__meat--2"></div><div class="burger__meat burger__meat--3"></div></div></div><nav class=nav id=navigation><ul class=nav__list><li><a href=https://tsumli.github.io/>about</a></li><li><a class=active href=https://tsumli.github.io/blog>blog</a></li></ul></nav><main><div class=flex-wrapper><div class=post__container><div class=post><header class=post__header><h1 id=post__title>Optimal Transport 02. エントロピー正則化</h1><time datetime="2021-02-13 13:55:54 +0000 UTC" class=post__date>Feb 13 2021</time></header><article class=post__content><p><a href=https://tsumli.github.io/blog/optimal-transport/01-introduction/>01. はじめ</a><br><a href=https://tsumli.github.io/blog/optimal-transport/02-entropy/>02. エントロピー正則化</a></p><p>Cuturi<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> の論文をもとに、Optimal Transportのエントロピー正則化について考えていきましょう 。</p><h2 id=計算量>計算量<a class=anchor href=#計算量>#</a></h2><p>$r$ から $c$ へのOptimal Transportは次のようになります
$$
\large
d_\mathbf{M}(r, c) \triangleq \min_{\mathbf{P}\in\mathbf{U}(r, c)} \langle \mathbf{P}, \mathbf{M} \rangle
$$
ここで、$\mathbf{M} \in \mathbb{R}^{d\times d}$ はcost matrixです<br>計算量について考えると、どのような行列$\mathbf{M}$に対しても最悪のケースで $O(d^3 \log d)$となります。</p><h2 id=エントロピー正則化>エントロピー正則化<a class=anchor href=#エントロピー正則化>#</a></h2><p>ここで、Optimal Transportにエントロピー正則化を導入します。<br>まず、同時確率分布に対する次の不等式が成り立ちます
$$
\forall r, c \in \Sigma_d, \forall \mathbf{P} \in \mathbf{U} (r, c), h(\mathbf{P}) \leq h(r) + h(c)
$$
また、$h(rc^\mathsf{T}) = h(r) + h(c)$ より次式が成り立ちます<br>$$
\begin{eqnarray*}
\mathbf{U}_\alpha (r, c) &\triangleq& \lbrace \mathbf{P} \in \mathbf{U} (r, c) \mid \mathrm{\bf KL}(\mathbf{P} \Vert rc^\mathsf{T}) \leq \alpha) \rbrace \\\<br>&=& \lbrace \mathbf{P} \in \mathbf{U} (r, c) \mid \mid h(\mathbf{P}) \geq h(r) + h(c) - \alpha \rbrace \\\<br>&\subset& \mathbf{U}(r, c)
\end{eqnarray*}
$$
ここで、$\mathrm{\bf KL}(\mathbf{P} \Vert rc^\mathsf{T}) = h(r) + h(c) - h(\mathbf{P})$</p><p>このように定義した同時分布に対して、Optimal Transportを解きます (得られた値を &ldquo;Sinkhorn Distance&rdquo; と呼びます) 。
$$
\large
d_{\mathbf{M}, \alpha} (r, c) \triangleq \min_{\mathbf{P}\in \mathbf{U}_{\alpha}(r, c)}\langle \mathbf{P}, \mathbf{M} \rangle
$$</p><p>このようにエントロピーを考える理由は2つ</p><ol><li>計算量的な問題</li><li>解をより"スムーズ"にしたい</li></ol><p>1については後で説明するとして、まず2について説明します。<a href=https://tsumli.github.io/blog/optimal-transport/01-introduction/>前回</a>
説明したように、
輸送計画行列 $\mathbf{P}$ は次の制約条件に従います
$$
\mathbf{P}\mathbf{1}_d = r \mathrm{\quad and\quad } \mathbf{P}^\mathsf{T}\mathbf{1}_d = c
$$
つまり、制約の個数は $2d$ 個となり、$\mathbf{P}$ は $0$ でない要素が $2d-1$ 個だけあって、それ以外は $0$ であるようなスパースな行列で制約を満たせるということです。
そこで、これを防ぐ (=行列をスムーズにする) ためにエントロピー正則化が必要となってくる。というわけです</p><h2 id=sinkhorns-algorithm>Sinkhorn&rsquo;s Algorithm<a class=anchor href=#sinkhorns-algorithm>#</a></h2><p>エントロピーで制限されたSinkhorn Distanceを考えます
$$
\newcommand{\argmin}{\mathop{\rm arg~min}\limits}
d_\mathbf{M}^\lambda(r,c) \triangleq \langle \mathbf{P}^\lambda, \mathbf{M} \rangle\ \\\<br>\mathrm{where}\ \lambda > 0 ,\ \mathbf{P}^\lambda = \argmin_{\mathbf{P}\in \mathbf{U}(r, c)} \langle \mathbf{P}, \mathbf{M} \rangle - \frac{1}{\lambda} h(\mathbf{P})
$$
ここで、それぞれの $\alpha$ はある $\lambda\in [0, \infty]$に対応します。
$$
d_{\mathbf{M}, \alpha} (r, c) = d_\mathbf{M}^\lambda (r, c)
$$</p><p>そして、この $d_\mathbf{M}^\lambda$ はもとの問題 ($=d_\mathbf{M}$) よりもはるかに低コストで計算できるのです。</p><h3 id=computing-d_mathbfmlambda>Computing $d_\mathbf{M}^\lambda$<a class=anchor href=#computing-d_mathbfmlambda>#</a></h3><p>$\lambda > 0$ に対して、$\mathbf{P}^\lambda$ はuniqueで、また、次の形式で表されます<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>
$$
\mathbf{P}^\lambda = \mathrm{diag}{(u)} \mathbf{K} \mathrm{diag}(v) \\\<br>\mathrm{where}\ u, v \in \mathbb{R}^d \mathrm{\ and\ non&ndash;negative}\\\<br>\mathbf{K} \triangleq \exp(-\lambda \mathbf{M})\quad \mathrm{(element&ndash;wise\ calculation)}
$$</p><p>そして、このとき$u, v$は解にiterativeに近づけていくことができます
$$
(u, v) \leftarrow (r_\cdot/\mathbf{K}v, c_\cdot/\mathbf{K}&lsquo;u)
$$</p><h3 id=empirical-complexity>Empirical Complexity<a class=anchor href=#empirical-complexity>#</a></h3><p>histgramの次元数に対する収束までに必要なiteration数は下図 (画像は元論文<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> 引用)<figure><img src=images/empirical.png></figure>次元数が増えると収束に必要なiteration数が増える。という訳ではなく、$\lambda$ の値がiteration数を決めます。
傾向として、$\lambda$ が大きくなるほど収束にかかるiterationも増えるようです。</p><h2 id=参考文献>参考文献<a class=anchor href=#参考文献>#</a></h2><ul><li><a href=https://arxiv.org/abs/1803.00567 target=_blank rel="noreferrer noopener">Computational optimal transport</a></li></ul><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><a href=https://papers.nips.cc/paper/2013/hash/af21d0c97db2e27e13572cbf59eb343d-Abstract.html target=_blank rel="noreferrer noopener">Sinkhorn Distances:
Lightspeed Computation of Optimal Transport</a>
<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p><a href=https://projecteuclid.org/euclid.pjm/1102992505 target=_blank rel="noreferrer noopener">Concerning nonnegative matrices and doubly stochastic matrices</a>
<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script><script type=text/x-mathjax-config>
    MathJax.Hub.Config({
            showMathMenu: false, //disables context menu
            tex2jax: {
            inlineMath: [ ['$','$'], ['\\(','\\)'] ]
           }
    });
</script></article><ul class=tags__list><li class=tag__item><a class=tag__link href=https://tsumli.github.io/tags/optimal-transport/>optimal-transport</a></li></ul><div class=pagination><a class=pagination__item href=https://tsumli.github.io/blog/optimal-transport/01-introduction/><span class=pagination__label>Previous Post</span>
<span class=pagination__title>Optimal Transport 01. はじめ</span></a>
<a class=pagination__item href=https://tsumli.github.io/blog/optimal-transport/03-unbalanced/><span class=pagination__label>Next Post</span>
<span class=pagination__title>Optimal Transport 03. Unbalanced Optimal Transport</span></a></div><footer class=post__footer><div class=social-icons><a class=social-icons__link rel=me title=GitHub href=https://github.com/tsumli target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://tsumli.github.io/svg/github.svg)></div></a><a class=social-icons__link rel=me title=Medium href=https://medium.com/@tsumli target=_blank rel=noopener><div class=social-icons__icon style=background-image:url(https://tsumli.github.io/svg/medium.svg)></div></a></div><p>© 2021</p></footer></div></div><div class=toc-container><div class=toc-post-title>Optimal Transport 02. エントロピー正則化</div><nav id=TableOfContents><ul><li><a href=#計算量>計算量</a></li><li><a href=#エントロピー正則化>エントロピー正則化</a></li><li><a href=#sinkhorns-algorithm>Sinkhorn&rsquo;s Algorithm</a><ul><li><a href=#computing-d_mathbfmlambda>Computing $d_\mathbf{M}^\lambda$</a></li><li><a href=#empirical-complexity>Empirical Complexity</a></li></ul></li><li><a href=#参考文献>参考文献</a></li></ul></nav></div></div></main><script src=https://tsumli.github.io/js/index.min.49e4d8a384357d9b445b87371863419937ede9fa77737522ffb633073aebfa44.js integrity="sha256-SeTYo4Q1fZtEW4c3GGNBmTft6fp3c3Ui/7YzBzrr+kQ=" crossorigin=anonymous></script><script src=https://unpkg.com/prismjs@1.20.0/components/prism-core.min.js></script><script src=https://unpkg.com/prismjs@1.20.0/plugins/autoloader/prism-autoloader.min.js data-autoloader-path=https://unpkg.com/prismjs@1.20.0/components/></script><script src=https://tsumli.github.io/js/table-of-contents.js></script></body></html>